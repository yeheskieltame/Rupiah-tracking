name: ğŸ§ª Test Subgraph Build

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: ğŸ“¦ Install Dependencies
      run: npm ci

    - name: ğŸ”§ Install Graph CLI
      run: npm install -g @graphprotocol/graph-cli

    - name: ğŸ—ï¸ Generate Code
      run: npm run codegen

    - name: ğŸ”¨ Build Subgraph
      run: npm run build

    - name: âœ… Validate Schema
      run: |
        # Check if schema.graphql is valid
        if [ ! -f "schema.graphql" ]; then
          echo "âŒ schema.graphql not found"
          exit 1
        fi
        echo "âœ… Schema file exists"

    - name: âœ… Validate Subgraph Configuration
      run: |
        # Check if subgraph.yaml is valid
        if [ ! -f "subgraph.yaml" ]; then
          echo "âŒ subgraph.yaml not found"
          exit 1
        fi
        echo "âœ… Subgraph configuration exists"

    - name: âœ… Check Generated Files
      run: |
        # Check if generated files exist
        if [ ! -d "generated" ]; then
          echo "âŒ Generated directory not found"
          exit 1
        fi
        if [ ! -f "generated/schema.ts" ]; then
          echo "âŒ Generated schema.ts not found"
          exit 1
        fi
        echo "âœ… Generated files exist"

    - name: âœ… Check Build Output
      run: |
        # Check if build output exists
        if [ ! -d "build" ]; then
          echo "âŒ Build directory not found"
          exit 1
        fi
        if [ ! -f "build/subgraph.yaml" ]; then
          echo "âŒ Built subgraph.yaml not found"
          exit 1
        fi
        echo "âœ… Build output exists"

    - name: ğŸ§ª Run Tests (if available)
      run: |
        if [ -f "package.json" ] && grep -q '"test"' package.json; then
          npm test
        else
          echo "â„¹ï¸ No tests configured, skipping"
        fi

    - name: ğŸ“Š Analyze Bundle Size
      run: |
        echo "ğŸ“¦ Build directory contents:"
        ls -la build/
        echo ""
        echo "ğŸ“ Generated directory contents:"
        ls -la generated/
        echo ""
        echo "âœ… Build analysis complete"

  lint-docs:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ“– Check Documentation
      run: |
        echo "ğŸ” Checking required documentation files..."
        
        required_files=("README.md" "CONTRIBUTING.md" "FUNDING.md" "QUERIES.md")
        missing_files=()
        
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            missing_files+=("$file")
          else
            echo "âœ… $file exists"
          fi
        done
        
        if [ ${#missing_files[@]} -ne 0 ]; then
          echo "âŒ Missing documentation files:"
          printf '%s\n' "${missing_files[@]}"
          exit 1
        fi
        
        echo "âœ… All required documentation files present"

    - name: ğŸ”— Check Links in README
      run: |
        echo "ğŸ” Checking for required links in README..."
        
        if ! grep -q "github.com/yeheskieltame/Rupiah-tracking" README.md; then
          echo "âŒ Repository link missing in README"
          exit 1
        fi
        
        if ! grep -q "0x86979D26A14e17CF2E719dcB369d559f3ad41057" README.md; then
          echo "âŒ Donation address missing in README"
          exit 1
        fi
        
        echo "âœ… Required links present in README"

  security-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: ğŸ“¦ Install Dependencies
      run: npm ci

    - name: ğŸ”’ Run Security Audit
      run: |
        echo "ğŸ” Running npm security audit..."
        npm audit --audit-level moderate
        
    - name: ğŸ” Check for Sensitive Files
      run: |
        echo "ğŸ” Checking for sensitive files..."
        
        sensitive_patterns=(".env" "*.key" "*.pem" "*secret*" "*private*")
        found_sensitive=()
        
        for pattern in "${sensitive_patterns[@]}"; do
          if find . -name "$pattern" -not -path "./node_modules/*" | grep -q .; then
            found_sensitive+=("$pattern")
          fi
        done
        
        if [ ${#found_sensitive[@]} -ne 0 ]; then
          echo "âš ï¸ Found potentially sensitive files:"
          printf '%s\n' "${found_sensitive[@]}"
          echo "Please review and add to .gitignore if needed"
        else
          echo "âœ… No sensitive files found"
        fi
