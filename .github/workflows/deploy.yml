name: ğŸš€ Deploy to Subgraph Studio

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version label for deployment'
        required: true
        default: 'v0.0.1'
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    environment: 
      name: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: ğŸ“¦ Install Dependencies
      run: npm ci

    - name: ğŸ”§ Install Graph CLI
      run: npm install -g @graphprotocol/graph-cli

    - name: ğŸ—ï¸ Generate Code
      run: npm run codegen

    - name: ğŸ”¨ Build Subgraph
      run: npm run build

    - name: âœ… Validate Build
      run: |
        echo "ğŸ” Validating build output..."
        
        if [ ! -d "build" ]; then
          echo "âŒ Build directory not found"
          exit 1
        fi
        
        if [ ! -f "build/subgraph.yaml" ]; then
          echo "âŒ Built subgraph.yaml not found"
          exit 1
        fi
        
        if [ ! -f "build/schema.graphql" ]; then
          echo "âŒ Built schema.graphql not found"
          exit 1
        fi
        
        echo "âœ… Build validation successful"

    - name: ğŸ” Configure Graph Auth
      env:
        GRAPH_DEPLOY_KEY: ${{ secrets.GRAPH_DEPLOY_KEY }}
      run: |
        if [ -z "$GRAPH_DEPLOY_KEY" ]; then
          echo "âŒ GRAPH_DEPLOY_KEY secret not configured"
          exit 1
        fi
        
        graph auth --studio $GRAPH_DEPLOY_KEY
        echo "âœ… Graph authentication configured"

    - name: ğŸ“‹ Deployment Info
      run: |
        VERSION="${{ github.event.inputs.version || github.ref_name }}"
        ENVIRONMENT="${{ github.event.inputs.environment || 'production' }}"
        
        echo "ğŸš€ Deployment Information:"
        echo "ğŸ“¦ Version: $VERSION"
        echo "ğŸŒ Environment: $ENVIRONMENT"
        echo "ğŸ“… Date: $(date)"
        echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
        echo "ğŸ”— Commit: ${{ github.sha }}"

    - name: ğŸš€ Deploy to Subgraph Studio
      env:
        VERSION: ${{ github.event.inputs.version || github.ref_name }}
      run: |
        echo "ğŸš€ Deploying subgraph version $VERSION..."
        
        # Deploy with version label
        graph deploy \
          --studio idrt-transaction-analyzer \
          --version-label "$VERSION" \
          --deploy-key ${{ secrets.GRAPH_DEPLOY_KEY }}
        
        echo "âœ… Deployment completed successfully!"

    - name: ğŸ“ Create Deployment Summary
      run: |
        VERSION="${{ github.event.inputs.version || github.ref_name }}"
        ENVIRONMENT="${{ github.event.inputs.environment || 'production' }}"
        
        echo "## ğŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ“¦ Version | \`$VERSION\` |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸŒ Environment | \`$ENVIRONMENT\` |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ“… Deployed At | \`$(date)\` |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ‘¤ Deployed By | \`${{ github.actor }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ”— Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ”— Links" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“Š [Subgraph Studio](https://thegraph.com/studio/subgraph/idrt-transaction-analyzer/)" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“– [Documentation](https://github.com/yeheskieltame/Rupiah-tracking/blob/main/README.md)" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ” [Query Examples](https://github.com/yeheskieltame/Rupiah-tracking/blob/main/QUERIES.md)" >> $GITHUB_STEP_SUMMARY

  notify:
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
    - name: ğŸ“¢ Deployment Notification
      run: |
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "âœ… Deployment successful! ğŸ‰"
          echo "ğŸ“Š Subgraph is now available at: https://thegraph.com/studio/subgraph/idrt-transaction-analyzer/"
        else
          echo "âŒ Deployment failed! ğŸ˜"
          echo "Please check the logs for more details."
        fi

    # Optional: Add Discord/Slack notification here
    # - name: ğŸ“± Discord Notification
    #   if: needs.deploy.result == 'success'
    #   uses: discord-message/action@main
    #   with:
    #     webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
    #     content: |
    #       ğŸš€ **IDRT Subgraph Deployed!**
    #       ğŸ“¦ Version: ${{ github.event.inputs.version || github.ref_name }}
    #       ğŸ”— https://thegraph.com/studio/subgraph/idrt-transaction-analyzer/
